rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function: Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ============================================
    // SHARED: Users collection (Web & App)
    // ============================================
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false; // Never delete user profiles

      // App: User statistics sub-collection
      match /statistics/{document=**} {
        allow read, write: if isOwner(userId);
      }

      // App: User game history sub-collection
      match /gameHistory/{gameId} {
        allow read, write: if isOwner(userId);
      }

      // App: User achievements sub-collection
      match /achievements/{achievementId} {
        allow read, write: if isOwner(userId);
      }

      // App: User skins sub-collection
      match /skins/{document=**} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // WEB: Saved games (AI games)
    // ============================================
    match /savedGames/{gameId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // WEB: Game history (top-level collection)
    // ============================================
    match /gameHistory/{historyId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if false; // History is immutable
      allow delete: if false;
    }

    // ============================================
    // WEB: Battle Replays
    // ============================================
    match /battleReplays/{replayId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      // Allow update only for the 'saved' field by the owner
      allow update: if isAuthenticated() &&
                      resource.data.userId == request.auth.uid &&
                      request.resource.data.diff(resource.data).affectedKeys().hasOnly(['saved']);
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // WEB: Online games (PvP)
    // ============================================
    match /onlineGames/{gameId} {
      allow read: if isAuthenticated() &&
        (resource.data.player1.id == request.auth.uid ||
         resource.data.player2.id == request.auth.uid);
      allow create: if isAuthenticated();
      allow update: if isAuthenticated() &&
        (resource.data.player1.id == request.auth.uid ||
         resource.data.player2.id == request.auth.uid);
      allow delete: if false;
    }

    // ============================================
    // WEB: Private rooms (4-digit code)
    // ============================================
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.hostId == request.auth.uid;
      allow update: if isAuthenticated() &&
        (resource.data.hostId == request.auth.uid ||
         resource.data.guestId == request.auth.uid ||
         resource.data.guestId == null);
      allow delete: if isAuthenticated() && resource.data.hostId == request.auth.uid;
    }

    // ============================================
    // WEB: Matchmaking queue
    // ============================================
    match /matchmaking/{orderId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============================================
    // APP: Matchmaking queue (different from Web)
    // ============================================
    match /matchmakingQueue/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    // ============================================
    // WEB: Leaderboards (cached rankings)
    // ============================================
    match /leaderboards/{boardId} {
      allow read: if true; // Public read
      allow write: if false; // Only cloud functions can write
    }

    // ============================================
    // APP: Leaderboard (different from Web)
    // ============================================
    match /leaderboard/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && userId == request.auth.uid;
    }

    // ============================================
    // WEB: In-App Purchases records
    // ============================================
    match /purchases/{purchaseId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // Purchases are immutable
      allow delete: if false;
    }

    // ============================================
    // WEB: User inventory (unlocked items)
    // ============================================
    match /inventory/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }
  }
}
